CREATE OR REPLACE VIEW V_WMS_ITEM_DETALHES AS
WITH DERIVACOES AS (
  -- 1. Pré-calcula a derivação máxima para cada produto/variação para otimizar o join
  SELECT
    CODPROD,
    CODVOL,
    MAX(DESCRDANFE) AS DERIVACAO
  FROM
    TGFVOA
  GROUP BY
    CODPROD,
    CODVOL
)
-- 2. Junta as informações principais com a derivação pré-calculada
SELECT
  ENDE.CODARM,
  ENDE.SEQEND,
  ENDE.CODRUA,
  ENDE.CODPRD,
  ENDE.CODAPT,
  ENDE.CODPROD,
  PRO.DESCRPROD,
  PRO.MARCA,
  ENDE.DATVAL,
  ENDE.QTDPRO,
  ENDE.ENDPIC,
  TO_CHAR(ENDE.QTDPRO) || ' ' || ENDE.CODVOL AS QTD_COMPLETA,
  DER.DERIVACAO
FROM
  AD_CADEND ENDE
  JOIN TGFPRO PRO ON PRO.CODPROD = ENDE.CODPROD
  LEFT JOIN DERIVACOES DER ON DER.CODPROD = ENDE.CODPROD AND DER.CODVOL = ENDE.CODVOL